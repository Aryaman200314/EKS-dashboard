<!-- Compute Tab -->
<div id="compute" class="tab-content">
    <!-- Nodes Section -->
    <div class="widget">
        <div class="widget-header">
            <h2>
                Nodes 
                <span id="node-count-wrapper" class="text-muted" style="display: none;">(<span id="node-count">0</span>)</span>
            </h2>
            <div class="resource-filters">
                <select id="nodegroup-filter" class="form-select" style="min-width: 220px;">
                    <option value="all">All Node Groups</option>
                    {% for ng in cluster.nodegroups_data if not ng.is_karpenter_node %}
                    <option value="{{ ng.name }}">{{ ng.name }}</option>
                    {% endfor %}
                    <option value="karpenter">Karpenter/Auto-Mode</option>
                </select>
            </div>
        </div>
        <div class="widget-content" style="padding:0;">
            <div class="table-container">
                <table class="data-table" id="nodes-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Instance Type</th>
                            <th>Node Group / Compute</th>
                            <th>Created At</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if cluster.workloads and cluster.workloads.nodes %}
                            {% for node in cluster.workloads.nodes %}
                                {% set labels = node.metadata.labels or {} %}
                                {% set nodegroup_name = labels.get('eks.amazonaws.com/nodegroup') %}
                                {% set is_karpenter_or_auto = 'karpenter.sh/provisioner-name' in labels or labels.get('eks.amazonaws.com/compute-type') == 'ec2' %}
                                {% set data_nodegroup_value = nodegroup_name if nodegroup_name else 'karpenter' if is_karpenter_or_auto else 'other' %}
                                {% set compute_display_name = nodegroup_name if nodegroup_name else 'Karpenter/Auto-Mode' if is_karpenter_or_auto else 'EC2 (Self-managed)' %}
                                {% set node_status_obj = (node.status.conditions | selectattr('type', 'equalto', 'Ready') | list | first) %}
                                {% set node_status = 'Ready' if node_status_obj and node_status_obj.status == 'True' else 'NotReady' %}

                                <tr data-nodegroup="{{ data_nodegroup_value }}">
                                    <td>{{ node.metadata.name }}</td>
                                    <td><span class="status-badge status-{{ node_status.lower() }}">{{ node_status }}</span></td>
                                    <td>{{ labels.get('node.kubernetes.io/instance-type', 'N/A') }}</td>
                                    <td>{{ compute_display_name }}</td>
                                    <td>{{ node.metadata.creationTimestamp.split('T')[0] if node.metadata.creationTimestamp else 'N/A' }}</td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-muted" style="text-align: center; padding: 2rem;">
                                    Node data not available. Workload fetching might be disabled or failed.
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Node Groups Section -->
    <div class="widget">
        <div class="widget-header"><h2>Node Groups</h2></div>
        <div class="widget-content" style="padding:0;">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Desired Size</th>
                            <th>AMI Release Version</th>
                            <th>K8s Version</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set managed_ngs = cluster.nodegroups_data | selectattr('is_karpenter_node', 'equalto', false) | list %}
                        {% for ng in managed_ngs %}
                        <tr>
                            <td>{{ ng.name }}</td>
                            <td><span class="status-badge status-{{ ng.status.lower() if ng.status else 'unknown' }}">{{ ng.status }}</span></td>
                            <td>{{ ng.desiredSize }}</td>
                            <td>{{ ng.releaseVersion }}</td>
                            <td>{{ ng.version }}</td>
                            <td>
                                {% if not ng.is_karpenter_node and ng.version != cluster.version %}
                                <button class="action-btn upgrade-btn" data-nodegroup-name="{{ ng.name }}"><i data-feather="chevrons-up"></i> Upgrade Now</button>
                                {% else %}<span class="text-muted">Up to date</span>{% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="6" class="text-muted" style="text-align: center; padding: 2rem;">
                                No managed nodegroups found.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Fargate Profiles Section -->
    <div class="widget">
        <div class="widget-header"><h2>Fargate Profiles</h2></div>
        <div class="widget-content" style="padding:0;">
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for profile in cluster.fargate_profiles %}
                        <tr>
                            <td>{{ profile.name }}</td>
                            <td><span class="status-badge status-{{ profile.status.lower() if profile.status else 'unknown' }}">{{ profile.status or 'Active' }}</span></td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="2" class="text-muted" style="text-align: center; padding: 2rem;">
                                No Fargate profiles found.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for dynamic node count visibility -->
<script>
function updateNodeCount() {
    const filter = document.getElementById('nodegroup-filter');
    const counterWrapper = document.getElementById('node-count-wrapper');
    const counter = document.getElementById('node-count');

    const selectedValue = filter?.value;

    if (!filter || !counter || !counterWrapper) return;

    // Hide count if "all" is selected
    if (selectedValue === 'all') {
        counterWrapper.style.display = 'none';
        return;
    } else {
        counterWrapper.style.display = 'inline';
    }

    // Count only visible rows
    const rows = document.querySelectorAll('#nodes-table tbody tr');
    let visibleCount = 0;

    rows.forEach(row => {
        const style = window.getComputedStyle(row);
        const isVisible = (
            style.display !== 'none' &&
            style.visibility !== 'hidden' &&
            row.offsetParent !== null
        );
        if (isVisible) visibleCount++;
    });

    counter.textContent = visibleCount;
}

function runAfterRender(callback) {
    requestAnimationFrame(() => {
        setTimeout(callback, 0);
    });
}

window.addEventListener('load', () => {
    runAfterRender(updateNodeCount);
});

document.getElementById('nodegroup-filter')?.addEventListener('change', () => {
    runAfterRender(updateNodeCount);
});
</script>
